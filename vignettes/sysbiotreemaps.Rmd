---
title: "Create Voronoi and Sunburst Treemaps from Hierarchical Data"
author: "Michael Jahn"
date: "`r Sys.Date()`"
output: github_document
#output: rmarkdown::html_vignette
#vignette: >
#  %\VignetteIndexEntry{}
#  %\VignetteEngine{knitr::rmarkdown}
#  %\VignetteEncoding{UTF-8}
#
# create README.md from R markdown source:
# knitr::knit("vignettes/sysbiotreemaps.Rmd", "README.md")
---


```{r setup, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  fig.path = ""
)
```

## Description

This package can be used to generate and plot Voronoi treemaps or
sunburst treemaps from hierarchical data. 

```{r, out.width = "700px",  fig.align = 'center', echo = FALSE}
#path = paste0(getwd(), "/vignettes/tm.png")
#knitr::include_graphics(path)
knitr::include_graphics("vignettes/tm.png")
```

There are different implementations for
Voronoi tesselations in R, the simplest being the deldir() function (from package deldir). However, deldir and other do not handle nested Voronoi tesselations, nor do they perform additively weighted Voronoi tesselation. This is an important demand for systems biology and other applications where one likes to scale the cell size (or area) to a set of predefined weights. The functions provided in this package allow both the additively weighted Voronoi tesselation, and the nesting of different hierarchical levels in one plot. The underlying functions for the tesselation
were developed and published by Paul Murrell, University of Auckland, and serve as the basis for this package. They are called by a recursive wrapper function, voronoiTreemap(), which subdivides the plot area in polygonal cells according to the highest hierarchical level.  It then continues with the tesselation on the next lower level uisng the child cell of the previous level as the new parental plotting cell, and so on. 

The sunburst treemap is a computationally less demanding treemap that does not require iterative refinement, but simply generates circle sectors that are sized according to predefined weights. It is also a arecursive algorithm and can be used to draw sectors of different hierarchical level with increasing granularity.

## Requirements

The C++ code requires the [CGAL](https://www.cgal.org/download.html) library.
Installation for (Ubuntu-like) Linux:

`sudo apt install libcgal-dev`

## Installation

To install the package directly from github, use this function from devtools package:

```
require(devtools)
devtools::install_github("https://github.com/m-jahn/SysbioTreemaps")
```
The package is not available on CRAN yet. 

## Usage

Create a simple example data frame

```
library(dplyr)
library(SysbioTreemaps)

df <- data.frame(
  A=rep(c("a", "b", "c"), each=15),
  B=sample(letters[4:13], 45, replace=TRUE),
  C=sample(1:100, 45)
)
```

Compute the treemap. It will return a list of grid graphics objects.

```
tm <- voronoiTreemap(
  data = data,
  levels = c("A", "B", "C"),
  cell.size = "C",
  cell.color = "A",
  maxIteration = 50,
)
```
Draw the treempap.

```
drawTreemap(tm)
```

```{r, out.width = "300px",  fig.align = 'center', echo = FALSE}
#path = paste0(getwd(), "/vignettes/tm_small.png")
#knitr::include_graphics(path)
knitr::include_graphics("vignettes/tm_small.png")
```

## Adcanced example

Read test data set from Jahn et al., Cell Reports, 2018.
(https://www.cell.com/cell-reports/fulltext/S2211-1247(18)31485-2)

```
df <- read.csv("data/Jahn_et_al_CellReports_2018.csv", 
  stringsAsFactors = FALSE) %>%
  subset(condition=="CO2-0-15")
```

Generate a custom color palette using colorspace.

```
library(colorspace); hclwizard()
custom.pal <- sequential_hcl(n = 40, 
  h = c(-100, 100), 
  c = c(60, NA, 66), 
  l = c(42, 100), 
  power = c(2.65, 0.7), 
  rev = TRUE)
```

Generate treemap using some more of the function's parameters. For example, we can supply more than one level for drawing labels, change label colors, encode cell size *and* cell color by a numeric variable, use a custom color palette, and increase maxIterations which will lead to lower errors in some cases.


```
tm <- voronoiTreemap(
  data = df,
  levels = c("Process.abbr", "Pathway.abbr", "protein"),
  labels = c("Process.abbr", "protein"),
  label.col = grey(0.7, 0.4),
  cell.size = "mean_mass_fraction_norm",
  cell.color = "mean_mass_fraction_norm",
  maxIteration = 200,
  color.palette = custom.pal
)
```

Draw treemap

```
drawTreemap(tm)
```

```{r, out.width = "700px",  fig.align = 'center', echo = FALSE}
#path = paste0(getwd(), "/vignettes/tm_heatcol.png")
#knitr::include_graphics(path)
knitr::include_graphics("vignettes/tm_heatcol.png")
```

## References and other treemap packages


The Voronoi tesselation is based on functions from Paul Murrell, https://www.stat.auckland.ac.nz/~paul/Reports/VoronoiTreemap/voronoiTreeMap.html.
We created a recursive wrapper around the main tesselation function and
improved the stability regarding generation of larger treemaps.

For a similar but JAVA based implementation of Voronoi treemaps wrapped in R, see
David Leslie's scripts at https://github.com/dlesl/voronoi_treemap_rJava.

Another popular resource is the web-based treemap generation from University of
Greifswald at https://bionic-vis.biologie.uni-greifswald.de/.
